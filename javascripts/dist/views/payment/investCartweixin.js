define(["jumi","limit","getPara","isLogin","wx","vue","vueTouch","weixin"],function(a,e,t,n,o,i,s,r){i.use(s);var d=localStorage.getItem("token"),c=t.get(),u=c.itemid,m=c.gearId,l=c.address_id?c.address_id:0,g=c.openId,p={addressId:l,requestSource:"WAP",gearId:m,token:d};$.ajax({url:"/needLogin/buy/getBuyOrderDetail",data:p,type:"post",dataType:"json",success:function(t){"0000"==t.code&&new i({el:"body",components:{"my-cart":{template:"#cartTemplate",data:function(){return{data:t.data,num:1,total:0,realtotal:0,canUseHongbao:0,isHongBao:!0,remark:""}},compiled:function(){var a=this;a.total=a.data.invPrice*a.num,a.canUseHongbao=Math.floor(a.data.hongBaoRate/1e3*a.data.invPrice*a.num),a.canUseHongbao>a.data.hongbaoBalance&&(a.canUseHongbao=a.data.hongbaoBalance),a.realtotal=a.total-a.canUseHongbao},methods:{toLink:function(){var a=this,e=a.data.costType;location.href="/h5/views/invest/investCartAddress.html?itemid="+u+"&gearId="+m+"&address_id="+l+"&costType="+e},count:function(){var a=this;a.total=a.data.invPrice*a.num,a.canUseHongbao=Math.floor(a.data.hongBaoRate/1e3*a.data.invPrice*a.num),a.canUseHongbao>a.data.hongbaoBalance&&(a.canUseHongbao=a.data.hongbaoBalance),a.isHongBao?a.realtotal=a.total-a.canUseHongbao:a.realtotal=a.total},add:function(){var e=this,t=99,n=99,o=99;return 1==e.data.isLimitUser&&(n=e.data.limitUser-e.data.supportCount),1==e.data.isCountLimit&&(o=e.data.limitCount-e.data.singleSupportCount),t=n>o?o:n,1==e.data.isLimitUser&&1==e.data.isCountLimit&&e.num>=t&&n<o?void a.tips("聚小米提醒您，该档位的剩余的库存不足～"):1==e.data.isLimitUser&&1==e.data.isCountLimit&&e.num>=t&&n>o?void a.tips("聚小米提醒您，您限购的份额已经不足～"):1==e.data.isLimitUser&&e.num>=t?void a.tips("聚小米提醒您，该档位的剩余的库存不足～"):1==e.data.isCountLimit&&e.num>=t?void a.tips("聚小米提醒您，您限购的份额已经不足～"):(++e.num,void e.count())},del:function(){var e=this;return e.num<=1?void a.tips("聚小米提醒您，购买数量不能低于1份~"):(--e.num,void e.count())},onoff:function(){var a=this;a.isHongBao=!a.isHongBao,a.count()},next:function(){var e=this;e.isHongBao?1:0,e.data.jmAddress?e.data.jmAddress.id:0,e.remark?e.remark:"";return 1!=e.data.orderType||e.data.jmAddress?void e.doWeixinPay():void a.tips("请选择一个地址！")},is_weixin:function(){var a=navigator.userAgent.toLowerCase();return"micromessenger"==a.match(/MicroMessenger/i)},getWeixinJS:function(){var e=this,t=decodeURIComponent(location.href.split("#")[0]),n={url:t,requestSource:"WAP"};e.is_weixin()&&$.ajax({url:"/weixin/initJs",type:"post",dataType:"json",data:n,success:function(e){"0000"==e.code?o.config({debug:!1,appId:e.data.appId,timestamp:e.data.timestamp,nonceStr:e.data.noncestr,signature:e.data.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","chooseImage","previewImage","getNetworkType","scanQRCode","chooseWXPay"]}):a.tips(e.msg)},error:function(){console.log("ajax error.")}})},doWeixinPay:function(){var e=this,t=e.isHongBao?1:0,n=e.data.jmAddress?e.data.jmAddress.id:0;if(e.getWeixinJS(),void 0==g)a.alert({content:"微信授权中,请耐心等待...",button:!1}),location.href="/buy/userOAuth?gearId="+m+"&itemid="+u+"&remark="+e.remark+"&invNum="+e.num+"&requestSource=WAP";else if(""==g)a.tips("未获取到openId");else{var o={addressId:n,gearId:m,invNum:e.num,isUseHongBao:t,openId:g,payChannel:"01",remark:e.remark,token:d,requestSource:"WAP"};$.ajax({type:"post",url:"/needLogin/buy/toPay",data:o,dataType:"json",success:function(t){"0000"==t.code?e.jsApiCall(t.data):a.tips(t.msg)}})}},jsApiCall:function(a){null!==a.wcPay?o.chooseWXPay({appId:a.wcPay.appId,timestamp:a.wcPay.timeStamp,nonceStr:a.wcPay.nonceStr,"package":a.wcPay["package"],signType:a.wcPay.signType,paySign:a.wcPay.paySign,complete:function(a){},success:function(e){location.href="/h5/views/invest/investSuccess.html?itemid="+u+"&investBillId="+a.investBillId},error:function(a){location.href="/h5/views/invest/investFail.html?errorMessage="+a+"&itemid="+u}}):alert("paraData.wcPay为空")}}}},ready:function(){$("#myloading").remove(),e({dom:"[data-remark]",numDom:"[data-limitnumber]",max:150}),r.setTitle().setDesc().setImg().setUrl().share()}})}})});